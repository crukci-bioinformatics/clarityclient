<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Apache Maven Doxia Site Renderer 1.7.4 at 2019-07-16 -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>CRUK-CI Genologics API Client &#x2013; </title>
    <style type="text/css" media="all">
      @import url("./css/maven-base.css");
      @import url("./css/maven-theme.css");
      @import url("./css/site.css");
    </style>
    <link rel="stylesheet" href="./css/print.css" type="text/css" media="print" />
    <meta http-equiv="Content-Language" content="en" />
        
        </head>
  <body class="composite">
    <div id="banner">
                    <div id="bannerLeft">
                CRUK-CI Genologics API Client
                </div>
                    <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
          
                <div class="xleft">
        <span id="publishDate">Last Published: 2019-07-16</span>
                  &nbsp;| <span id="projectVersion">Version: 2.26.1</span>
                      </div>
            <div class="xright">      
      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
           
                                <h5>User Guide</h5>
                  <ul>
                  <li class="none">
                          <a href="index.html" title="Introduction">Introduction</a>
            </li>
                  <li class="none">
                          <a href="installing.html" title="Installation">Installation</a>
            </li>
                                                                                                                              <li class="expanded">
                          <a href="usageoverview.html" title="Usage">Usage</a>
                    <ul>
                      <li class="none">
                          <a href="spring.html" title="Spring Configuration">Spring Configuration</a>
            </li>
                      <li class="none">
                          <a href="usage.html" title="Basic Usage">Basic Usage</a>
            </li>
                      <li class="none">
            <strong>Caching</strong>
          </li>
                      <li class="none">
                          <a href="serverside.html" title="Server Deployment">Server Deployment</a>
            </li>
              </ul>
        </li>
                  <li class="none">
                          <a href="issues.html" title="Known Issues">Known Issues</a>
            </li>
                  <li class="none">
                          <a href="references.html" title="Reference Documentation">Reference Documentation</a>
            </li>
          </ul>
                       <h5>Project Documentation</h5>
                  <ul>
                                                                                                                                                                                                                                                                          <li class="collapsed">
                          <a href="project-info.html" title="Project Information">Project Information</a>
                  </li>
                                                                                      <li class="collapsed">
                          <a href="project-reports.html" title="Project Reports">Project Reports</a>
                  </li>
          </ul>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="poweredBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                 
            </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
        <div class="section">
<h2><a name="Caching"></a>Caching</h2>
<p>Using the in-memory cache with the client can <b>massively</b> increase the speed a script can run. It accumulates a number of entities from REST API calls so subsequent calls to retrieve these same entities need not pass through to the API. This also has the effect to simplifying user code, as the script can make the calls through the <tt><a href="./apidocs/org/cruk/genologics/api/GenologicsAPI.html">GenologicsAPI</a></tt> interface without worrying about whether it already has some or all of the objects requested.</p>
<p>Like any client side caching, there are risks that an entity will be updated from elsewhere while the client holds an earlier copy of the object. This hasn't presented us much of a problem in EPP scripts (where this client is used a lot) as these run from beginning to end and then stop, so the lifetime of the cache is simply the duration of the script.</p>
<p>If used in a server environment, the cache can still be beneficial but it may need to be tweaked so objects don't live as long in the cache. We've found that most operations rarely hit the same objects from two different people (though this is a risk) and the performance gain much outweighs the risk of out of date information. The cache can be tuned or disabled as required by the application.</p>
<div class="section">
<h3><a name="Enabling_the_cache"></a>Enabling the cache</h3>
<p>The cache is essentially an aspect around the main <tt>GenologicsAPI</tt> implementation. It is configured with Spring and can be enabled for an application by adding a file to Spring's application context path:</p>
<div class="source">
<pre>/org/cruk/genologics/api/genologics-cache-context.xml</pre></div>
<p>This configuration does require the general <tt>/org/cruk/genologics/api/genologics-client-context.xml</tt> configuration to be in Spring's application context path as it depends on beans defined there.</p>
<p><tt>genologics-cache-context.xml</tt> is provided in the client's JAR file.</p></div>
<div class="section">
<h3><a name="Tuning_the_cache"></a>Tuning the cache</h3>
<p>The cache is controlled by the file:</p>
<div class="source">
<pre>/org/cruk/genologics/api/ehcache.xml</pre></div>
<p>This file is also provided in the client's JAR file. It provides caches for different entities that can be individually tuned for each class in the API. Any class that does not have a specific cache defined goes into the catch-all cache <i>com.genologics.ri.LimsEntity</i>.</p>
<p>If you do need to change the cache configuration, make a new <tt>org/cruk/genologics/api/ehcache.xml</tt> that appears in a folder or JAR before the client's JAR file in the class path.</p></div>
<div class="section">
<h3><a name="Bulk_fetch_create_and_update_operations"></a>Bulk fetch, create and update operations</h3>
<p>Real world use has found that the bulk operations for fetching, creating and updating objects from the API has a &quot;sweet spot&quot; for the number of objects in an operation. This is a number that minimises the request time per object. For example, if one tries fetching 10,000 artifacts in one call to the API's &quot;<tt>.../artifacts/batch/retrieve</tt>&quot; end point it will take longer than making 20 calls for 500 artifacts (500 per call is the optimum number given by Genologics, though testing has shown this can vary between installations).</p>
<p>As of release 2.22, the client library will batch bulk operations with large numbers of objects into one or more calls to the relevant API end point transparently to the user. So we can request our 10,000 artifacts in one call to the client and let that fetch them in the most efficent manner.</p>
<p>The number of objects to retrieve or send in each batch can be tuned with the <tt>setBulkOperationBatchSize</tt> method on the client. The default is the recommended 500 per call to the API.</p></div>
<div class="section">
<h3><a name="Artifacts_and_their_state_parameter"></a>Artifacts and their state parameter</h3>
<p>The <tt>Artifact</tt> class provides some complication to the cache by always having a <i>state</i> parameter attached to its URIs. This means a given artifact can be returned in different states depending on the state in the URI.</p>
<p>The cache can be put in one of three modes for dealing with <tt>Artifact</tt> objects:</p>
<ol style="list-style-type: decimal">
<li><tt>EXACT</tt>: The version of the artifact requested by the state parameter must match the version in the cache exactly. If it is older or newer than the cached version, the requested version is fetched and replaces that already in the cache.</li>
<li><tt>LATEST</tt>: If the version of the artifact requested by the state parameter is newer than the version in the cache, the requested version is fetched and replaces the version in the cache. If it is the same version or older, the newer version in the cache is returned.</li>
<li><tt>ANY</tt>: The cached version of the artifact is returned regardless of the version requested by the state parameter.</li></ol>
<p>If an artifact is requested without an explicit state in the URI, the artifact in the cache is returned regardless of its version or the mode of cache operation.</p>
<p>The default mode is <tt>LATEST</tt>, which is the way the cache behaved in releases of the client before 2.22. Modes can be set in the Spring configuration (<tt>genologics-cache-context.xml</tt>) or programmatically on the <tt>GenologicsAPICache</tt> bean using the <tt>setStatefulBehaviour</tt> method.</p></div>
<div class="section">
<h3><a name="Overriding_the_cache_to_get_the_latest_version"></a>Overriding the cache to get the latest version</h3>
<p>In actual use, the only time the state parameter is important for an artifact is when one is looking for its QC flag value. No other fields have a history that is preserved by the state: they are always their current database value. Most of the time the cache behaviour is irrelevant, and the <tt>LATEST</tt> or <tt>ANY</tt> cache behaviours are most suitable for the performance gain they provide. This is not true when using the post process URI of the input/output maps to obtain the QC flags.</p>
<p>Releases 4.24.8 and 2.26.1 introduced the method <tt><a href="./apidocs/org/cruk/genologics/api/GenologicsAPI.html">fetchLatestVersions</a></tt> to the API. This does nothing to the server, but instructs the cache and the API client to go back to the server for the latest versions of the artifacts regardless on whether they are in the cache or not. The <i>state</i> parameter is removed from the URL or URLs and the fetch is always performed. The artifacts returned will be placed in the cache, but if the client is again instructed to fetch one of these artifacts in its latest state, the call will go through to the Clarity API again.</p>
<p>The &quot;fetch latest&quot; behaviour is only relevant to artifacts and is in place for exactly one call to the API after the <tt>fetchLatestVersions</tt> call. It will always be cleared after the next call to the API, regardless of whether it actually has an effect after that call (e.g. calling <tt>fetchLatestVersions</tt> and then <tt>getServer</tt> will cause the behaviour to be cleared), so one should put the call to <tt>fetchLatestVersions</tt> immediately before the call to <tt>retrieve</tt>, <tt>load</tt>, <tt>loadAll</tt> or <tt>reload</tt>. This behaviour is local to the calling thread, so will not affect calls to the API from other threads.</p></div></div>
      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
              Copyright &#169;                    2013&#x2013;2019
                        <a href="http://www.cruk.cam.ac.uk">Cancer Research UK Cambridge Institute</a>.
            All rights reserved.    
                  </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
